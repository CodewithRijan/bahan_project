{% extends 'crowdsource_app/base.html' %}
{% load static %}
{% block title %}
Bahan - Stop
{% endblock title %}
{% block content %}
<!-- Main Content Container -->
<div class="container mt-5">

    <div class="card border-0 shadow-lg overflow-hidden mb-5">
        <div class="row g-0">

            <div class="col-md-5 position-relative bg-light">
                <!-- Using a placeholder image for the demo -->
                {% if stop_id < 5 %} <img src="{{ photo_url }}" class="img-fluid h-100 w-100 object-fit-cover"
                    alt="{{ bus_stop_name }}" style="min-height: 250px;">
                    {% else %}
                    <img src="images/bus_stop_placeholder.jpg" class="img-fluid h-100 w-100 object-fit-cover"
                        alt="{{ bus_stop_name }}" style="min-height: 250px;">
                    {% endif %}

                    <!-- Overlay Badge -->
                    <span
                        class="position-absolute top-0 start-0 m-3 badge bg-dark bg-opacity-75 rounded-pill px-3 py-2 backdrop-blur">
                        <i class="fas fa-map-marker-alt me-1"></i> Kathmandu
                    </span>
            </div>

            <!-- RIGHT SIDE: Details -->
            <div class="col-md-7">
                <div class="card-body p-4 d-flex flex-column h-100">

                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h2 class="card-title fw-bold mb-1 text-dark">{{ bus_stop_name }} Bus Stop</h2>
                            <p class="text-muted small mb-0">
                                <i class="fas fa-route text-primary me-1"></i> Routes: Ring Road, Bhaktapur, Lagankhel
                            </p>
                        </div>

                        <!-- Mock Rating -->
                        <div class="text-end">
                            <div class="text-warning fs-5">
                                <span class="fw-bold text-dark me-1">{{average_rating}}</span>
                            </div>
                            <small class="text-muted" style="font-size: 0.8rem;">{{noOfRatings}} reviews</small>
                        </div>
                    </div>

                    <hr class="my-3 opacity-10">

                    <!-- Amenities Badges -->
                    <div class="row g-2 mb-4">
                        <div class="col-auto">
                            <span class="badge rounded-pill bg-light text-dark border fw-normal px-3 py-2">
                                <i class="fas fa-chair text-secondary me-1"></i> Seating
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge rounded-pill bg-light text-dark border fw-normal px-3 py-2">
                                <i class="fas fa-umbrella text-secondary me-1"></i> Shelter
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge rounded-pill bg-light text-dark border fw-normal px-3 py-2">
                                <i class="fas fa-lightbulb text-warning me-1"></i> Lit at Night
                            </span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-auto d-flex gap-2">
                        <button class="btn btn-primary px-4 rounded-pill fw-bold shadow-sm" data-bs-toggle="modal"
                            data-bs-target="#ratingModal">
                            <i class="fas fa-star me-2"></i>Rate Stop
                        </button>

                        <a href="#" class="btn btn-outline-secondary px-4 rounded-pill">
                            <i class="fas fa-directions me-2"></i>Directions
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="row g-4">

        <!-- LEFT COLUMN: The Timer (Sticky) -->
        <div class="col-lg-4">
            <div class="timer-card p-4 text-center">
                <div class="mb-3">
                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                        <i class="fas fa-clock me-1"></i> Contribute Data
                    </span>
                </div>

                <h5 class="fw-bold text-dark">Waiting for a bus?</h5>
                <p class="text-muted small">Start the timer. When your bus arrives, stop it to help others.</p>

                <!-- The Big Timer -->
                <div class="timer-display" id="timerDisplay">00:00:00</div>

                <button class="btn btn-primary btn-lg w-100 rounded-pill fw-bold shadow-sm" id="startBtn"
                    data-bs-toggle="modal" data-bs-target="#routeModal">
                    <i class="fas fa-play me-2"></i>Start My Wait
                </button>

                <!-- Hidden Controls -->
                <div id="runningControls" class="btn-group-timer" style="display: none; margin-top: 15px;">
                    <button class="btn btn-danger btn-lg w-100 rounded-pill fw-bold mb-2" id="stopBtn">
                        <i class="fas fa-bus me-2"></i>Bus Arrived!
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 rounded-pill" id="resetBtn">
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: The Community Feed (Wait Logs) -->
        <div class="col-lg-8">

            <!-- Header for the Feed -->
            <div class="feed-header">
                <h4 class="fw-bold m-0">Live Community Updates</h4>
                <p class="text-muted small m-0">Recent departures reported by users at this stop.</p>
            </div>

            <!-- LOG CARD  -->
            <div class="log-card route-border-ring">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <!-- User Info -->
                    <div class="d-flex align-items-center">
                        <div class="user-avatar">R</div> <!-- First letter of username -->
                        <span class="fw-bold text-dark small">rijan1233</span>
                        <span class="mx-2 text-muted">&bull;</span>
                        <span class="time-ago"><i class="far fa-clock me-1"></i>1 min ago</span>
                    </div>
                    <!-- Like Button -->
                    <form action="{% url 'crowdsource_app:waitlog_likes' stop_id=stop_id %}" method="post">
                        <button type="button" class="btn btn-sm btn-outline-light text-secondary border-0">
                            <i class="far fa-thumbs-up"></i> 5
                        </button>
                    </form>
                </div>

                <!-- Main Message -->
                <h5 class="fw-bold text-dark mb-3">
                    <i class="fas fa-bus-alt text-success me-2"></i>
                    Bus going <span class="text-primary fw-bold">Ring Road</span> left <span class="text-dark">1 minute
                        ago</span>.
                </h5>

                <!-- Footer: Wait Time Badge -->
                <div class="wait-badge">
                    <i class="fas fa-stopwatch me-2 text-secondary"></i>
                    User waited for: 02 min 30 sec
                </div>
            </div>

        </div>
    </div>

</div>
</div>

<!--
        Wait Log Modal
        -->
<div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Which bus are you waiting for?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <p class="text-muted small">Select your route to help us calculate accurate wait times.</p>
                {%csrf_token%}
                <select class="form-select form-select-lg mb-3" id="routeSelect">
                    <option value="" selected disabled>-- Select a route --</option>
                    <option value="ring-road">Ring Road (चक्रपथ)</option>
                    <option value="ratna-park-lagankhel">Ratna Park - Lagankhel</option>
                    <option value="chabahil-kalanki">Chabahil - Kalanki</option>
                    <option value="other">Other / Unknown</option>
                </select>
                <div id="routeError" class="alert alert-danger py-2 small" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i> Please select a route to continue.
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" id="beginWaitBtn">Begin Wait</button>
            </div>
        </div>
    </div>
</div>
<!-- Wait log other stuff here -->
<!-- Rating model code here  -->
<div class="modal fade" id="ratingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rate Ratna Park</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="mb-3">How would you rate your experience?</p>

                {% load crispy_forms_tags %}
                <form action="{% url 'crowdsource_app:add_rating' stop_id=stop_id %}" method="post">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <textarea class="form-control my-2" placeholder="Any comments on safety or amenities?"></textarea>
                    <button type="submit" class="btn btn-primary w-100">Submit Review</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block extrascripts %}
<script>
    var bus_stop_id = "{{ stop_id }}";
</script>
<script type="text/JavaScript" src="{% static 'crowdsource_app/stop.js' %}"></script>
{% endblock %}